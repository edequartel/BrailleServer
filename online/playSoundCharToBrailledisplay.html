<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Letter Tester</title>
  <style>
    :root {
      font-family: system-ui, sans-serif;
      background: #f5f5f7;
      color: #222;
    }

    body {
      margin: 0;
      padding: 0;
      display: flex;
      min-height: 100vh;
      align-items: center;
      justify-content: center;
    }

    .app {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.10);
      padding: 24px 28px 28px;
      max-width: 700px;
      width: 100%;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 1.6rem;
    }

    .subtitle {
      margin: 0 0 18px;
      font-size: 0.95rem;
      color: #666;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: #f1f1f3;
      margin-bottom: 18px;
      font-size: 0.9rem;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #d22;
      box-shadow: 0 0 0 3px rgba(210, 34, 34, 0.15);
      flex-shrink: 0;
    }

    .status-indicator.connected {
      background: #1ba64a;
      box-shadow: 0 0 0 3px rgba(27, 166, 74, 0.2);
    }

    .status-text {
      flex: 1;
    }

    .status-extra {
      font-size: 0.8rem;
      color: #777;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #eef5ff;
      font-size: 0.75rem;
      color: #3456aa;
    }

    .tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #3456aa;
    }

    .logging-toggle {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      background: #e8e8ff;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .logging-toggle.off {
      background: #fbe3e3;
    }

    .button-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    button.char-btn {
      padding: 14px 0;
      font-size: 1.4rem;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #f8f8ff, #e5e7fb);
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
    }

    button.char-btn:active {
      transform: translateY(2px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.10);
      background: linear-gradient(135deg, #e2e4ff, #cbd0ff);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-size: 0.9rem;
      margin-bottom: 12px;
    }

    .info-label {
      font-weight: 600;
    }

    .info-value {
      font-family: "SF Mono", ui-monospace, Menlo, Consolas, monospace;
    }

    .log-container {
      margin-top: 8px;
    }

    .log-title {
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #666;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .log {
      font-family: "SF Mono", ui-monospace, Menlo, Consolas, monospace;
      font-size: 0.8rem;
      background: #0b1020;
      color: #d6e2ff;
      border-radius: 10px;
      padding: 10px 12px;
      max-height: 120px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .log.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <main class="app" aria-label="BrailleBridge letter tester">
    <header>
      <div class="top-row">
        <div>
          <h1>Letter Tester</h1>
          <p class="subtitle">
           <!-- Click a letter to show it on the braille display and play a sound.-->
			Kies een letter, je hoort de letter en het is op de leesregel.
          </p>
        </div>
        <button id="toggleLoggingBtn" class="logging-toggle">
          Logging: ON
        </button>
      </div>
    </header>

    <!-- Connection status -->
    <section class="status-bar" aria-live="polite">
      <div id="statusIndicator" class="status-indicator"></div>
      <div class="status-text">
        <div id="statusLine">Connecting to BrailleBridge…</div>
        <div id="deviceLine" class="status-extra"></div>
      </div>
      <div class="tag">
        <span class="tag-dot"></span>
        <span>localhost:5000</span>
      </div>
    </section>

    <!-- Character buttons -->
    <section aria-label="Characters">
      <div class="button-grid">
        <button class="char-btn" data-char="a">a</button>
        <button class="char-btn" data-char="b">b</button>
        <button class="char-btn" data-char="k">k</button>
        <button class="char-btn" data-char="l">l</button>
      </div>
    </section>

    <!-- Info -->
    <section class="info-row">
      <div>
        <div class="info-label">Last character sent</div>
        <div id="lastChar" class="info-value">—</div>
      </div>
      <div>
        <div class="info-label">Bridge response</div>
        <div id="lastResponse" class="info-value">—</div>
      </div>
    </section>

    <!-- Simple event/log view -->
    <section class="log-container" aria-label="BrailleBridge log">
      <div class="log-title">
        <span>Bridge log (WebSocket events, errors, etc.)</span>
        <span id="loggingStatusLabel">(visible)</span>
      </div>
      <div id="log" class="log"></div>
    </section>
  </main>

  <script>
    const statusIndicator = document.getElementById("statusIndicator");
    const statusLine      = document.getElementById("statusLine");
    const deviceLine      = document.getElementById("deviceLine");
    const lastChar        = document.getElementById("lastChar");
    const lastResponse    = document.getElementById("lastResponse");
    const logEl           = document.getElementById("log");
    const toggleLoggingBtn = document.getElementById("toggleLoggingBtn");
    const loggingStatusLabel = document.getElementById("loggingStatusLabel");

    const BRIDGE_HTTP = "http://localhost:5000";
    const BRIDGE_WS   = "ws://localhost:5000/ws";

    // --- Logging toggle ---
    let loggingEnabled = true;

    function updateLoggingUI() {
      if (loggingEnabled) {
        toggleLoggingBtn.textContent = "Logging: ON";
        toggleLoggingBtn.classList.remove("off");
        logEl.classList.remove("hidden");
        loggingStatusLabel.textContent = "(visible)";
      } else {
        toggleLoggingBtn.textContent = "Logging: OFF";
        toggleLoggingBtn.classList.add("off");
        logEl.classList.add("hidden");
        loggingStatusLabel.textContent = "(hidden)";
      }
    }

    toggleLoggingBtn.addEventListener("click", () => {
      loggingEnabled = !loggingEnabled;
      updateLoggingUI();
    });

    function log(msg) {
      if (!loggingEnabled) return;
      const ts = new Date().toLocaleTimeString();
      logEl.textContent = `[${ts}] ${msg}\n` + logEl.textContent;
    }

    function setConnected(connected, reason = "") {
      if (connected) {
        statusIndicator.classList.add("connected");
        statusLine.textContent = "BrailleBridge: connected";
        if (reason) log(`Connected: ${reason}`);
      } else {
        statusIndicator.classList.remove("connected");
        statusLine.textContent = "BrailleBridge: not connected";
        if (reason) log(`Disconnected: ${reason}`);
      }
    }

    async function fetchDevices() {
      try {
        const res = await fetch(`${BRIDGE_HTTP}/devices`, { method: "GET" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        if (Array.isArray(json) && json.length > 0) {
          deviceLine.textContent = "Devices: " + json.join(" | ");
        } else {
          deviceLine.textContent = "No devices reported by bridge.";
        }
      } catch (err) {
        deviceLine.textContent = "Could not read devices.";
        log("Error fetching /devices: " + err.message);
      }
    }

    async function pingBridge() {
      try {
        const res = await fetch(`${BRIDGE_HTTP}/ping`, { method: "GET" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        log(`Ping: ${text.trim()}`);
      } catch (err) {
        log("Ping failed: " + err.message);
      }
    }

    // --- Audio setup ---
    // Change these paths to where your audio files are stored.
    const charSounds = {
      a: new Audio("sounds/alfabet//a.mp3"),
      b: new Audio("sounds/alfabet/b.mp3"),
      k: new Audio("sounds/alfabet/k.mp3"),
      l: new Audio("sounds/alfabet/l.mp3")
    };

    function playCharSound(character) {
      const audio = charSounds[character];
      if (!audio) return;
      // reset and play
      audio.currentTime = 0;
      audio.play().catch(err => {
        log("Audio play error: " + err.message);
      });
    }

    async function sendToBraille(character) {
      lastChar.textContent = character;
      lastResponse.textContent = "sending…";

      // Play sound immediately on click
      playCharSound(character);

      try {
        const res = await fetch(`${BRIDGE_HTTP}/braille`, {
          method: "POST",
          headers: {
            "Content-Type": "text/plain; charset=utf-8"
          },
          body: character
        });

        const text = await res.text().catch(() => "");
        if (res.ok) {
          lastResponse.textContent = text || "OK";
          log(`Sent "${character}" → /braille: ${res.status} ${text}`);
        } else {
          lastResponse.textContent = `Error ${res.status}`;
          log(`Error sending to /braille: ${res.status} ${text}`);
        }
      } catch (err) {
        lastResponse.textContent = "Network error";
        log("Network error sending to /braille: " + err.message);
      }
    }

    // Attach click handlers to character buttons
    document.querySelectorAll("button.char-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const ch = btn.getAttribute("data-char") ?? "";
        if (!ch) return;
        sendToBraille(ch);
      });
    });

    // WebSocket for key events + connection state
    let ws;
    function connectWebSocket() {
      log("Opening WebSocket…");
      try {
        ws = new WebSocket(BRIDGE_WS);

        ws.addEventListener("open", () => {
          setConnected(true, "WebSocket open");
          pingBridge();
          fetchDevices();
        });

        ws.addEventListener("message", evt => {
          // Bridge sends JSON BrailleLogicalEvent
          // { kind, cursorIndex, name, isPress }
          try {
            const data = JSON.parse(evt.data);
            log("WS event: " + JSON.stringify(data));
          } catch {
            log("WS text: " + evt.data);
          }
        });

        ws.addEventListener("close", () => {
          setConnected(false, "WebSocket closed");
        });

        ws.addEventListener("error", err => {
          setConnected(false, "WebSocket error");
          log("WebSocket error");
        });
      } catch (err) {
        log("WebSocket init failed: " + err.message);
        setConnected(false, "WS init failed");
      }
    }

    // Init
    window.addEventListener("load", () => {
      updateLoggingUI();
      setConnected(false);
      statusLine.textContent = "Connecting to BrailleBridge…";
      connectWebSocket();
    });
  </script>
</body>
</html>
