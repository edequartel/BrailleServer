<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Braille Game â€“ Kies het juiste woord</title>

  <!-- Jouw algemene stijl -->
  <link rel="stylesheet" href="../css/style.css" />

  <!-- Howler -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>

  <!-- BrailleBridge & Sounds framework -->
  <script src="../js/braillebridge.js"></script>
  <script src="../js/sounds.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 20px;
      background: #f5f5f7;
    }
    .container {
      max-width: 760px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 18px;
      padding: 22px 22px 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.14);
    }
    h1 {
      margin-top: 0;
      font-size: 1.7rem;
    }
    .button-row button {
      margin: 4px;
    }
    .status {
      border: 1px solid #ddd;
      padding: 8px;
      margin: 6px 0;
      border-radius: 8px;
      background: #fafafa;
    }
    #currentLineBox {
      font-family: "Consolas", monospace;
      font-size: 20px;
      letter-spacing: 2px;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
    }
    #logContainer {
      margin-top: 10px; /* standaard zichtbaar nu */
    }
    #log {
      border: 1px solid #888;
      padding: 10px;
      height: 220px;
      overflow-y: auto;
      white-space: pre-wrap;
      background: #111827;
      color: #e5e7eb;
      font-family: Consolas, monospace;
      font-size: 0.8rem;
      border-radius: 6px;
    }
    .connection-ok {
      color: #15803d;
    }
    .connection-bad {
      color: #b91c1c;
    }
  </style>
</head>

<body>
<div class="container">

  <h1>Braille Game â€“ Kies het juiste woord</h1>

  <p>
    Op de brailleleesregel staan de woorden:
    <em>boom, plant, school, computer, stoel, fles, pen</em> in willekeurige volgorde.<br>
    Je hoort Ã©Ã©n woord. Druk op de <strong>cursorrouting</strong> boven dat woord.
  </p>

  <ul>
    <li>De woorden staan achter elkaar met een spatie ertussen.</li>
    <li>Druk op de cursorrouting boven een letter van het gekozen woord.</li>
  </ul>

  <div id="connectionStatus" class="connection-bad">WebSocket: nog niet verbondenâ€¦</div>

  <h2>Bediening</h2>
  <div class="button-row">
    <button id="btnStartRound">Nieuwe ronde</button>
    <button id="btnRepeatTarget">Herhaal doelwoord</button>
    <button id="btnRepeatLine">Herhaal brailleregel</button>
    <button id="btnClear">Maak braille leeg</button>
  </div>

  <h2>Ronde</h2>
  <div class="status" id="roundInfo">Nog geen ronde gestart.</div>

  <h2>Woord(en) op brailleleesregel</h2>
  <div class="status" id="currentLineBox">(leeg)</div>

  <h2>Laatste antwoord</h2>
  <div class="status" id="lastAnswerBox">Nog geen antwoord.</div>

  <div id="logContainer">
    <h2>Log (inclusief cursorrouting-events)</h2>
    <div id="log"></div>
  </div>

</div>

<script>
  const MAX_CELLS = 40;
  const NEXT_ROUND_DELAY = 3000;
  const WORDS = ["boom", "plant", "school", "computer", "stoel", "fles", "pen"];

  let currentLineText = "";
  let wordPositions = [];   // [{ word, start, end }]
  let targetWord = null;

  function pageLog(msg) {
    const log = document.getElementById("log");
    const t = new Date().toLocaleTimeString();
    log.textContent += `[${t}] ${msg}\n`;
    log.scrollTop = log.scrollHeight;
  }

  function setConnectionStatus(text, ok) {
    const el = document.getElementById("connectionStatus");
    el.textContent = "WebSocket: " + text;
    el.className = ok ? "connection-ok" : "connection-bad";
  }

  function setRoundInfo(text) {
    document.getElementById("roundInfo").textContent = text;
  }

  function setCurrentLineDisplay(text) {
    document.getElementById("currentLineBox").textContent = text || "(leeg)";
  }

  function setLastAnswer(text) {
    document.getElementById("lastAnswerBox").textContent = text;
  }

  function randomFrom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  function shuffledCopy(arr) {
    const copy = arr.slice();
    for (let i = copy.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [copy[i], copy[j]] = [copy[j], copy[i]];
    }
    return copy;
  }

  function buildLine() {
    const shuffled = shuffledCopy(WORDS);
    let text = "";
    const positions = [];

    for (const w of shuffled) {
      let extraLen = w.length;
      if (text.length > 0) extraLen += 1; // spatie

      if (text.length + extraLen > MAX_CELLS) continue;

      const startIndex = text.length + (text.length > 0 ? 1 : 0);
      if (text.length === 0) text = w;
      else text += " " + w;
      const endIndex = startIndex + w.length; // exclusief

      positions.push({ word: w, start: startIndex, end: endIndex });
    }

    return { text, positions };
  }

  function startNewRound() {
    const { text, positions } = buildLine();

    if (!text || positions.length === 0) {
      setRoundInfo("Kon geen woorden plaatsen op de regel (te weinig cellen?).");
      pageLog("Geen woorden geplaatst â€“ controleer MAX_CELLS.");
      return;
    }

    currentLineText = text;
    wordPositions = positions;

    const usedWords = positions.map(p => p.word);
    targetWord = randomFrom(usedWords);

    const padded = currentLineText.padEnd(MAX_CELLS, " ").substring(0, MAX_CELLS);

    setCurrentLineDisplay(currentLineText);
    setLastAnswer("Nog geen antwoord.");
    setRoundInfo(
      `Nieuwe ronde: luister goed en kies het woord met cursorrouting.`
    );

    pageLog(
      `Nieuwe ronde: line="${currentLineText}", target="${targetWord}", words=[${usedWords.join(", ")}]`
    );

    Sounds.playWord("nl", targetWord);

    BrailleBridge.sendText(padded, { pad: false, cells: MAX_CELLS })
      .then(r => pageLog("sendText â†’ " + (r && r.status)))
      .catch(e => pageLog("sendText error: " + e));
  }

  function repeatTargetWord() {
    if (!targetWord) return;
    Sounds.playWord("nl", targetWord);
    pageLog("Doelwoord opnieuw afgespeeld: " + targetWord);
  }

  function repeatLine() {
    if (!currentLineText) return;
    const padded = currentLineText.padEnd(MAX_CELLS, " ").substring(0, MAX_CELLS);
    BrailleBridge.sendText(padded, { pad: false, cells: MAX_CELLS });
    pageLog("Brailleregel opnieuw verzonden: " + currentLineText);
  }

  // Zoek woord bij index (first try raw index, then index-1)
  function findWordByIndex(rawIndex) {
    const idx = Number(rawIndex);
    if (!Number.isFinite(idx)) return null;

    // direct
    for (const info of wordPositions) {
      if (idx >= info.start && idx < info.end) return info.word;
    }

    // 1-based â†’ 0-based
    const idxMinusOne = idx - 1;
    for (const info of wordPositions) {
      if (idxMinusOne >= info.start && idxMinusOne < info.end) return info.word;
    }

    return null;
  }

  function handleCursorRouting(rawIndex) {
    pageLog(`handleCursorRouting â†’ rawIndex=${rawIndex}`);

    const chosen = findWordByIndex(rawIndex);
    if (!chosen) {
      setLastAnswer("Er is geen woord onder deze cursorpositie.");
      pageLog("Geen woord gevonden bij rawIndex=" + rawIndex);
      Sounds.playUI("nl", "mistake");
      return;
    }

    const correct = (chosen === targetWord);
    pageLog(`Gekozen woord="${chosen}", target="${targetWord}", correct=${correct}`);

    if (correct) {
      setLastAnswer(`Goed! Je koos "${chosen}", dat is het juiste woord.`);
      Sounds.playUI("nl", "correct");
    } else {
      setLastAnswer(`Fout. Je koos "${chosen}", het juiste woord is "${targetWord}".`);
      Sounds.playUI("nl", "mistake");
    }

    setTimeout(startNewRound, NEXT_ROUND_DELAY);
  }

  window.addEventListener("DOMContentLoaded", async () => {
    await Sounds.init("../config/sounds.json", pageLog);

    BrailleBridge.setConfig({
      baseUrl: "http://localhost:5000",
      wsUrl: "ws://localhost:5000/ws",
      displayCells: MAX_CELLS,
      debug: true
    });

    // Algemene WS events:
    BrailleBridge.on("connected", () => {
      setConnectionStatus("verbonden", true);
      pageLog("BrailleBridge connected.");
    });

    BrailleBridge.on("disconnected", () => {
      setConnectionStatus("verbroken", false);
      pageLog("BrailleBridge disconnected.");
    });

    // Log ALLE ruwe messages:
    BrailleBridge.on("message", evt => {
      pageLog("WS message: " + JSON.stringify(evt));
    });

    BrailleBridge.on("unknown", evt => {
      pageLog("WS unknown: " + JSON.stringify(evt));
    });

    // ðŸ”´ HIER: cursorrouting in de log heel duidelijk
    BrailleBridge.on("cursor", evt => {
      pageLog("CURSOR EVENT: " + JSON.stringify(evt));
      pageLog(
        ` â†’ kind=${evt.kind} press=${evt.press} index=${evt.index}`
      );
      if (typeof evt.index === "number") {
        handleCursorRouting(evt.index);
      } else {
        pageLog("CURSOR EVENT heeft geen numerieke index!");
      }
    });

    BrailleBridge.on("thumbkey", evt => {
      pageLog("Thumbkey: " + JSON.stringify(evt));
    });

    BrailleBridge.on("error", err => {
      pageLog("ERROR event: " + JSON.stringify(err));
    });

    BrailleBridge.connect();

    document.getElementById("btnStartRound").onclick = startNewRound;
    document.getElementById("btnRepeatTarget").onclick = repeatTargetWord;
    document.getElementById("btnRepeatLine").onclick = repeatLine;
    document.getElementById("btnClear").onclick = () => {
      BrailleBridge.clearDisplay();
      pageLog("Display leeggemaakt");
    };
  });
</script>

</body>
</html>
