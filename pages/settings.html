<!-- /settings.html -->
<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Settings</title>

  <style>
    :root{
      --bg:#0b0c10;
      --panel:#12141b;
      --text:#e8eaf0;
      --muted:#aab0c0;
      --border:#2a2f3a;
      --focus:#8aa4ff;
      --radius:12px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --panel:#ffffff;
        --text:#111827;
        --muted:#6b7280;
        --border:#e5e7eb;
        --focus:#3056ff;
      }
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.4;
    }
    header{
      position:sticky;
      top:0;
      background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0));
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border);
    }
    .wrap{
      max-width: 880px;
      margin: 0 auto;
      padding: 16px;
    }
    .bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 0;
    }
    h1{ font-size:18px; margin:0; }

    main .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      margin-top:16px;
    }
    .row{
      display:grid;
      grid-template-columns: 220px 1fr;
      gap:14px;
      align-items:start;
      padding:12px 0;
      border-top:1px solid var(--border);
    }
    .row:first-child{ border-top:none; padding-top:0; }
    .label{ font-weight:700; }
    .hint{ color:var(--muted); font-size:13px; margin-top:6px; }

    select{
      width:100%;
      border-radius:10px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      padding:10px 12px;
      font-size:15px;
    }
    select:focus-visible, input:focus-visible{
      outline: 3px solid color-mix(in srgb, var(--focus) 55%, transparent);
      outline-offset: 2px;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .toast{
      margin-top:12px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:10px;
      background: color-mix(in srgb, var(--panel) 60%, transparent);
      display:none;
    }
    .toast.show{ display:block; }

    /* Debug box */
    .debug{
      margin-top:16px;
      padding:12px;
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--muted);
      font-size:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space:pre-wrap;
    }
  </style>

  <script src="./js/settings-store.js"></script>
  <script src="./js/i18n.js"></script>
</head>

<body>
<header>
  <div class="wrap">
    <div class="bar">
      <h1 data-i18n="settings.title">Settings</h1>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="card">

      <!-- Language -->
      <div class="row">
        <div>
          <div class="label" data-i18n="settings.language.label">Language</div>
          <div class="hint" data-i18n="settings.language.hint">Used by runner and BrailleMonitor.</div>
        </div>
        <div>
          <select id="langSelect" aria-label="Language">
            <option value="nl" data-i18n="settings.language.option.nl">Nederlands (nl)</option>
            <option value="en" data-i18n="settings.language.option.en">English (en)</option>
          </select>
        </div>
      </div>

      <!-- SSOC Simulator -->
      <div class="row">
        <div>
          <div class="label" data-i18n="settings.sim.label">SSOC Simulator</div>
          <div class="hint" data-i18n="settings.sim.hint">Enable BrailleMonitor simulator when BrailleBridge is unavailable.</div>
        </div>
        <div class="toggle">
          <input type="checkbox" id="simToggle" />
          <label for="simToggle" data-i18n="settings.sim.toggle">Use simulator</label>
        </div>
      </div>

      <!-- Method -->
      <div class="row">
        <div>
          <div class="label" data-i18n="settings.method.label">Method</div>
          <div class="hint" data-i18n="settings.method.hint">Select the active teaching method.</div>
        </div>
        <div>
          <select id="methodSelect" aria-label="Method">
            <option value="mpop.json" data-i18n="settings.method.option.mpop">MPOP</option>
            <option value="marechal.json" data-i18n="settings.method.option.marechal">Mar√©chal</option>
          </select>
        </div>
      </div>

      <!-- Braille mode -->
      <div class="row">
        <div>
          <div class="label" data-i18n="settings.braillemode.label">Braille mode</div>
          <div class="hint" data-i18n="settings.braillemode.hint">Choose between 6-dot literacy braille and 8-dot computer braille.</div>
        </div>
        <div>
          <select id="brailleModeSelect" aria-label="Braille mode">
            <option value="literacy" data-i18n="settings.braillemode.option.literacy">Literacy (6 dots)</option>
            <option value="computer" data-i18n="settings.braillemode.option.computer">Computer (8 dots)</option>
          </select>
        </div>
      </div>

      <div id="toast" class="toast" role="status" aria-live="polite"></div>

      <!-- Debug output (visible) -->
      <div id="debugBox" class="debug">Debug: (loading...)</div>
    </div>
  </div>
</main>

<script>
(function () {
  "use strict";

  const BASE_PATH = ""; // settings.html is at root; pages/* would use "../"

  const elLang        = document.getElementById("langSelect");
  const elSim         = document.getElementById("simToggle");
  const elMethod      = document.getElementById("methodSelect");
  const elBrailleMode = document.getElementById("brailleModeSelect");
  const elToast       = document.getElementById("toast");
  const elDebug       = document.getElementById("debugBox");

  let dict = null;

  function toast(msg) {
    elToast.textContent = msg;
    elToast.classList.add("show");
    setTimeout(() => elToast.classList.remove("show"), 1200);
  }

  function debug(obj) {
    elDebug.textContent = safeJson(obj);
  }

  function safeJson(x) {
    try { return JSON.stringify(x, null, 2); } catch { return String(x); }
  }

  function forceSelectRepaint(selectEl) {
    // Some browsers keep showing the "old" selected option text after we change option labels.
    // Re-setting selectedIndex forces repaint.
    const idx = selectEl.selectedIndex;
    selectEl.selectedIndex = -1;
    selectEl.selectedIndex = idx;
  }

  async function applyLang(lang) {
    const res = await window.I18n.loadAndApply({ lang, basePath: BASE_PATH });
    dict = res.dict;

    document.title = window.I18n.t(dict, "settings.title", "Settings");

    // Force repaint for selects whose option texts are i18n'd
    forceSelectRepaint(elLang);
    forceSelectRepaint(elMethod);
    forceSelectRepaint(elBrailleMode);

    debug({
      when: new Date().toISOString(),
      basePath: BASE_PATH,
      langApplied: res.lang,
      applied: res.applied,
      title: document.title
    });

    window.I18n.log("[settings] applyLang done", { lang: res.lang, applied: res.applied });
  }

  async function syncUI() {
    const state = window.SettingsStore.load();

    elLang.value = state.lang;
    elSim.checked = !!state.ssocSimulator;
    elMethod.value = state.method;
    elBrailleMode.value = state.brailleMode || "literacy";

    await applyLang(state.lang);

    window.I18n.log("[settings] syncUI", state);
  }

  async function update(patch) {
    const state = window.SettingsStore.patch(patch);

    // Apply i18n immediately when language changes
    if (patch && Object.prototype.hasOwnProperty.call(patch, "lang")) {
      await applyLang(state.lang);
    }

    toast(window.I18n.t(dict, "ui.saved", "Saved"));
    window.I18n.log("[settings] updated", { patch, state });
  }

  elLang.addEventListener("change", async () => {
    await update({ lang: window.I18n.normalizeLang(elLang.value) });
  });

  elSim.addEventListener("change", async () => {
    await update({ ssocSimulator: elSim.checked });
  });

  elMethod.addEventListener("change", async () => {
    await update({ method: elMethod.value });
  });

  elBrailleMode.addEventListener("change", async () => {
    await update({ brailleMode: elBrailleMode.value });
  });

  window.addEventListener("pageshow", () => {
    // iOS BFCache safe
    syncUI();
  });

  syncUI();
})();
</script>
</body>
</html>