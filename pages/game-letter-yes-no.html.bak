<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Braille Game ‚Äì Staat de letter vooraan?</title>

  <!-- Standaard stijl -->
  <link rel="stylesheet" href="../css/style.css" />

  <!-- Howler -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>

  <!-- Frameworks -->
  <script src="../js/braillebridge.js"></script>
  <script src="../js/sounds.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 700px; margin: auto; }
    .button-row button { margin: 5px; }
    #log {
      border: 1px solid #888;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      background: #fafafa;
      margin-top: 10px;
    }
    .status {
      border: 1px solid #ccc;
      padding: 8px;
      margin: 5px 0;
      background: #f5f5f5;
    }
    #currentLineBox {
      font-family: "Consolas", monospace;
      font-size: 20px;
      letter-spacing: 2px;
      background: #fff;
      padding: 10px;
      border-radius: 4px;
    }
  </style>
</head>

<body>
<div class="container">

  <h1>Braille Game ‚Äì Staat de letter vooraan?</h1>
  <p>
    Je hoort een letter en voelt de brailleleesregel.<br>
    <strong>Vraag:</strong> Staat de gehoorde letter vooraan?
  </p>

  <ul>
    <li><strong>LeftThumb</strong> ‚Üí De letter staat <strong>NIET</strong> vooraan.</li>
    <li><strong>RightThumb</strong> ‚Üí De letter staat <strong>W√âL</strong> vooraan.</li>
  </ul>

  <div id="connectionStatus">WebSocket: nog niet verbonden‚Ä¶</div>

  <h2>Bediening</h2>
  <div class="button-row">
    <button id="btnStartRound">Nieuwe ronde</button>
    <button id="btnRepeatLetter">Herhaal letter</button>
    <button id="btnRepeatLine">Herhaal braillelijn</button>
    <button id="btnClear">Maak braille leeg</button>
  </div>

  <h2>Ronde</h2>
  <div class="status" id="roundInfo">Nog geen ronde gestart.</div>

  <h2>Brailleregel (exact zoals verzonden)</h2>
  <div class="status" id="currentLineBox">(leeg)</div>

  <h2>Laatste antwoord</h2>
  <div class="status" id="lastAnswerBox">Nog geen antwoord.</div>

  <h2>Log</h2>
  <div id="log"></div>

</div>

<script>
  const MAX_CELLS = 40;
  const LETTER_KEYS_NL = ["a","b","c","d","e","f","g","h","k","l","m"];

  // ‚è± Meer tijd tussen antwoord en volgende letter
  const NEXT_ROUND_DELAY = 3000; // 3 seconden

  let currentLetter = null;
  let isAtFront = null;
  let currentLine = "";

  function pageLog(msg) {
    const log = document.getElementById("log");
    const time = new Date().toLocaleTimeString();
    log.textContent += `[${time}] ${msg}\n`;
    log.scrollTop = log.scrollHeight;
    console.log(msg);
  }

  function setConnectionStatus(text, ok) {
    const el = document.getElementById("connectionStatus");
    el.textContent = "WebSocket: " + text;
    el.style.color = ok ? "green" : "red";
  }

  function setRoundInfo(text) {
    document.getElementById("roundInfo").textContent = text;
  }

  function setCurrentLineDisplay(text) {
    if (!text) {
      document.getElementById("currentLineBox").textContent = "(leeg)";
      return;
    }
    const visual = text.replace(/ /g, "¬∑");
    document.getElementById("currentLineBox").textContent = visual;
  }

  function setLastAnswer(text) {
    document.getElementById("lastAnswerBox").textContent = text;
  }

  function randomFrom(a) {
    return a[Math.floor(Math.random() * a.length)];
  }

  function buildLineWithLetter(letter) {
    const front = Math.random() < 0.5;
    let line = "";

    if (front) {
      line = letter;
      const fillChars = LETTER_KEYS_NL.concat([" "]);
      while (line.length < 10) line += randomFrom(fillChars);
    } else {
      const others = LETTER_KEYS_NL.filter(ch => ch !== letter);
      line = randomFrom(others);

      const pos = 1 + Math.floor(Math.random() * 5);
      while (line.length < pos) line += " ";
      line += letter;

      const fillChars = others.concat([" "]);
      while (line.length < 10) line += randomFrom(fillChars);
    }

    return { line, isAtFront: front };
  }

  function startNewRound() {
    currentLetter = randomFrom(LETTER_KEYS_NL);

    const result = buildLineWithLetter(currentLetter);
    const padded = result.line.padEnd(MAX_CELLS, " ").substring(0, MAX_CELLS);

    currentLine = padded;
    isAtFront = result.isAtFront;

    setCurrentLineDisplay(currentLine);
    setLastAnswer("Nog geen antwoord.");
    setRoundInfo(`Nieuwe ronde: staat "${currentLetter.toUpperCase()}" vooraan?`);

    pageLog(`Nieuwe ronde: letter="${currentLetter}", front=${isAtFront}`);

    // Speel lettergeluid
    Sounds.playLetter("nl", currentLetter);

    // Stuur naar brailleregel
    BrailleBridge.sendText(currentLine, { pad: false, cells: MAX_CELLS })
      .then(r => pageLog("sendText ‚Üí " + r.status))
      .catch(e => pageLog("sendText error: " + e));
  }

  function repeatLetter() {
    if (!currentLetter) return;
    Sounds.playLetter("nl", currentLetter);
    pageLog("Letter opnieuw afgespeeld");
  }

  function repeatLine() {
    if (!currentLine) return;
    BrailleBridge.sendText(currentLine, { pad: false, cells: MAX_CELLS });
    pageLog("Brailleregel opnieuw verzonden");
  }

  function handleUserAnswer(userSaysFront, src) {
    if (currentLetter == null) return;

    const correct = (userSaysFront === isAtFront);
    const word = userSaysFront ? "JA" : "NEE";

    pageLog(`${src}: ${word} ‚Üí correct=${correct}`);

    if (correct) {
      setLastAnswer(`Goed! "${word}" klopt.`);
      Sounds.playUI("nl", "correct");   // üëç ui/correct.mp3
    } else {
      setLastAnswer(`Fout! "${word}" klopt niet.`);
      Sounds.playUI("nl", "mistake");   // üëç ui/mistake.mp3
    }

    // Wacht wat langer v√≥√≥r de volgende letter komt
    setTimeout(startNewRound, NEXT_ROUND_DELAY);
  }

  function handleThumbKey(name) {
    pageLog("Thumb: " + name);

    if (name === "leftthumb") handleUserAnswer(false, "LeftThumb");
    if (name === "rightthumb" || name === "rightthumbkey") handleUserAnswer(true, "RightThumb");
  }

  window.addEventListener("DOMContentLoaded", async () => {

    await Sounds.init("../config/sounds.json", pageLog);

    BrailleBridge.setConfig({
      baseUrl: "http://localhost:5000",
      wsUrl: "ws://localhost:5000/ws",
      displayCells: MAX_CELLS,
      debug: true
    });

    BrailleBridge.on("connected", () => setConnectionStatus("verbonden", true));
    BrailleBridge.on("disconnected", () => setConnectionStatus("verbroken", false));

    BrailleBridge.on("thumbkey", evt => handleThumbKey(evt.nameLower));
    BrailleBridge.on("cursor", evt => pageLog("Cursor index=" + evt.index));
    BrailleBridge.on("error", err => pageLog("ERROR: " + err.error));

    BrailleBridge.connect();

    document.getElementById("btnStartRound").onclick = startNewRound;
    document.getElementById("btnRepeatLetter").onclick = repeatLetter;
    document.getElementById("btnRepeatLine").onclick = repeatLine;
    document.getElementById("btnClear").onclick = () => {
      BrailleBridge.clearDisplay();
      pageLog("Display leeggemaakt");
    };

    startNewRound();
  });
</script>

</body>
</html>
