<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Luisterverhaal ‚Äì bal</title>

  <!-- Jouw globale stijl -->
  <link rel="stylesheet" href="../css/style.css">

  <!-- Howler.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
  <!-- Sounds-framework -->
  <script src="../js/sounds.js"></script>

  <style>
    /* Extra aankleding bovenop style.css */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #e0f2fe, #eef2ff 45%, #f9fafb 100%);
      color: #111827;
    }

    .page-wrapper {
      max-width: 900px;
      margin: 40px auto;
      padding: 0 16px;
    }

    .story-card {
      background: rgba(255,255,255,0.97);
      border-radius: 20px;
      box-shadow:
        0 18px 40px rgba(15, 23, 42, 0.18),
        0 0 0 1px rgba(148, 163, 184, 0.18);
      padding: 24px 22px 20px;
      position: relative;
      overflow: hidden;
    }

    .story-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left,
        rgba(59,130,246,0.10),
        transparent 55%);
      pointer-events: none;
    }

    .story-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
      position: relative;
      z-index: 1;
    }

    .story-icon {
      width: 56px;
      height: 56px;
      border-radius: 18px;
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 28px;
      flex-shrink: 0;
      box-shadow: 0 10px 25px rgba(59,130,246,0.45);
    }

    h1 {
      font-size: 1.6rem;
      margin: 0 0 4px;
    }

    .subtitle {
      margin: 0;
      color: #6b7280;
      font-size: 0.95rem;
    }

    .story-body {
      margin-top: 10px;
      margin-bottom: 16px;
      font-size: 0.98rem;
      color: #374151;
      position: relative;
      z-index: 1;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }

    .play-button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #ecfdf5;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 24px rgba(22,163,74,0.45);
      transition: transform 0.08s, box-shadow 0.08s, filter 0.12s;
    }

    .play-button span.icon {
      font-size: 1.2rem;
    }

    .play-button:hover {
      filter: brightness(1.05);
    }

    .play-button:active {
      transform: translateY(1px);
      box-shadow: 0 6px 16px rgba(22,163,74,0.5);
    }

    .play-button:focus-visible {
      outline: 2px solid #2563eb;
      outline-offset: 3px;
    }

    .pill {
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.18);
      color: #4b5563;
    }

    .secondary-button {
      border-radius: 999px;
      border: none;
      padding: 7px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      background: #e5e7eb;
      color: #374151;
    }

    .secondary-button:hover {
      background: #d4d4d8;
    }

    .timeline {
      margin-top: 10px;
      margin-bottom: 6px;
      position: relative;
      z-index: 1;
    }

    .timeline-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .timeline-progress {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #3b82f6, #6366f1);
      transition: width 0.15s linear;
    }

    .timeline-time {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 0.8rem;
      color: #6b7280;
      font-variant-numeric: tabular-nums;
    }

    .status-text {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #4b5563;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #9ca3af;
    }
    .status-dot.playing { background: #22c55e; }
    .status-dot.paused  { background: #f97316; }
    .status-dot.idle    { background: #9ca3af; }
    .status-dot.error   { background: #ef4444; }

    .hint-line {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #6b7280;
    }

    .debug-mini {
      margin-top: 10px;
      font-size: 0.78rem;
      color: #9ca3af;
      font-family: "Consolas", monospace;
      max-height: 80px;
      overflow-y: auto;
      border-top: 1px dashed rgba(148,163,184,0.5);
      padding-top: 4px;
    }

    @media (max-width: 640px) {
      .story-card {
        border-radius: 16px;
        padding: 18px 16px;
      }
      .story-header {
        align-items: flex-start;
      }
      h1 {
        font-size: 1.4rem;
      }
      .story-icon {
        width: 48px;
        height: 48px;
        font-size: 24px;
      }
    }
  </style>
</head>

<body>
  <div class="page-wrapper">
    <div class="story-card" aria-live="polite">
      <div class="story-header">
        <div class="story-icon" aria-hidden="true">üéß</div>
        <div>
          <h1 id="storyTitle">Luisterverhaal ‚Äì bal</h1>
          <p class="subtitle" id="storySubtitle">
            Het woord ‚Äúbal‚Äù als luisterverhaal uit de stories-map.
          </p>
        </div>
      </div>

      <div class="story-body" id="storyDescription">
        Druk op afspelen om het verhaal <strong>bal</strong> te horen. De audio wordt
        geladen via <code>sounds.json</code> en <code>sounds.js</code> (categorie <em>stories</em>).
      </div>

      <div class="controls-row">
        <button id="btnPlay" type="button" class="play-button">
          <span id="playIcon" class="icon">‚ñ∂</span>
          <span id="playLabel">Afspelen</span>
        </button>

        <button id="btnRestart" type="button" class="secondary-button">
          Opnieuw vanaf begin
        </button>

        <span class="pill" id="metaPill">Verhaal ‚Äúbal‚Äù ¬∑ NL</span>
      </div>

      <div class="timeline">
        <div class="timeline-bar">
          <div id="timelineProgress" class="timeline-progress"></div>
        </div>
        <div class="timeline-time">
          <span id="currentTime">00:00</span>
          <span id="totalTime">00:00</span>
        </div>
      </div>

      <p class="hint-line">
        Tip: gebruik de <strong>spatiebalk</strong> om te pauzeren of hervatten.
      </p>

      <div class="status-text">
        <span id="statusDot" class="status-dot idle"></span>
        <span id="statusText">Voorbereiden‚Ä¶</span>
      </div>

      <div id="debugArea" class="debug-mini"></div>
    </div>
  </div>

  <script>
    const STORY_LANG = "nl";
    const STORY_KEY  = "bal";

    let storyHowl = null;
    let progressTimer = null;

    const elPlayBtn  = document.getElementById("btnPlay");
    const elRestart  = document.getElementById("btnRestart");
    const elPlayIcon = document.getElementById("playIcon");
    const elPlayLabel = document.getElementById("playLabel");

    const elProgress = document.getElementById("timelineProgress");
    const elCurTime  = document.getElementById("currentTime");
    const elTotTime  = document.getElementById("totalTime");

    const elStatusDot  = document.getElementById("statusDot");
    const elStatusText = document.getElementById("statusText");
    const elDebug      = document.getElementById("debugArea");

    function debug(msg) {
      const t = new Date().toLocaleTimeString();
      elDebug.textContent += `[${t}] ${msg}\n`;
      elDebug.scrollTop = elDebug.scrollHeight;
      console.log("[story-bal]", msg);
    }

    function setStatus(mode, text) {
      elStatusDot.className = "status-dot " + mode;
      elStatusText.textContent = text;
    }

    function formatTime(sec) {
      if (!isFinite(sec) || sec < 0) sec = 0;
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
    }

    function updatePlayButtonUI(playing) {
      if (playing) {
        elPlayIcon.textContent = "‚è∏";
        elPlayLabel.textContent = "Pauzeer";
      } else {
        elPlayIcon.textContent = "‚ñ∂";
        elPlayLabel.textContent = "Afspelen";
      }
    }

    function startProgress() {
      stopProgress();
      progressTimer = setInterval(() => {
        if (!storyHowl) return;
        let pos = 0;
        let dur = 0;
        try {
          pos = storyHowl.seek() || 0;
          dur = storyHowl.duration() || 0;
        } catch { /* ignore */ }

        elCurTime.textContent = formatTime(pos);
        elTotTime.textContent = formatTime(dur);
        const pct = dur > 0 ? (pos / dur) * 100 : 0;
        elProgress.style.width = pct.toFixed(1) + "%";
      }, 200);
    }

    function stopProgress() {
      if (progressTimer) {
        clearInterval(progressTimer);
        progressTimer = null;
      }
    }

    async function initSounds() {
      try {
        await Sounds.init("../config/sounds.json", debug);
        debug("Sounds.init klaar. baseUrl=" + Sounds._config.baseUrl);

        // Gebruik de bestaande URL-logica uit sounds.js
        const url = Sounds._buildUrl(STORY_LANG, "stories", STORY_KEY);
        debug("URL voor verhaal: " + url);

        // Haal (of maak) de Howl via de cache-laag van Sounds
        storyHowl = Sounds._getHowl(url);

        // Extra event handlers toevoegen voor UI
        storyHowl.on("load", () => {
          const dur = storyHowl.duration() || 0;
          elTotTime.textContent = formatTime(dur);
          debug("Audio geladen, duur = " + dur.toFixed(2) + "s");
          setStatus("idle", "Klaar om af te spelen.");
        });

        storyHowl.on("play", () => {
          updatePlayButtonUI(true);
          setStatus("playing", "Afspelen‚Ä¶");
          startProgress();
        });

        storyHowl.on("pause", () => {
          updatePlayButtonUI(false);
          setStatus("paused", "Gepauzeerd.");
        });

        storyHowl.on("stop", () => {
          updatePlayButtonUI(false);
          setStatus("idle", "Gestopt.");
          stopProgress();
          elProgress.style.width = "0%";
          elCurTime.textContent = "00:00";
        });

        storyHowl.on("end", () => {
          updatePlayButtonUI(false);
          setStatus("idle", "Verhaal afgelopen.");
          stopProgress();
          elProgress.style.width = "100%";
        });

        storyHowl.on("loaderror", (id, err) => {
          setStatus("error", "Fout bij laden van audio.");
          debug("loaderror: " + err);
        });

        storyHowl.on("playerror", (id, err) => {
          setStatus("error", "Fout bij afspelen.");
          debug("playerror: " + err);
        });

        setStatus("idle", "Verhaal wordt voorbereid‚Ä¶ (eventueel buffer)");
      } catch (err) {
        setStatus("error", "Fout bij het laden van sounds.json");
        debug("Sounds.init error: " + err);
      }
    }

    function togglePlay() {
      if (!storyHowl) {
        debug("Geen storyHowl beschikbaar.");
        return;
      }
      try {
        if (storyHowl.playing()) {
          storyHowl.pause();
        } else {
          storyHowl.play();
        }
      } catch (err) {
        setStatus("error", "Kon niet afspelen.");
        debug("togglePlay error: " + err);
      }
    }

    function restartStory() {
      if (!storyHowl) return;
      try {
        storyHowl.seek(0);
        storyHowl.play();
      } catch (err) {
        debug("restart error: " + err);
      }
    }

    elPlayBtn.addEventListener("click", togglePlay);
    elRestart.addEventListener("click", restartStory);

    window.addEventListener("keydown", ev => {
      if (ev.code === "Space") {
        ev.preventDefault();
        togglePlay();
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      setStatus("idle", "Sounds worden geladen‚Ä¶");
      initSounds();
    });
  </script>
</body>
</html>
