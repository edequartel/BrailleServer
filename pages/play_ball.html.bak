<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Luisterverhaal – bal</title>

  <!-- Jouw standaard stijl -->
  <link rel="stylesheet" href="../css/style.css">

  <!-- Howler.js voor audio -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>

  <style>
    /* Extra aankleding bovenop jouw style.css */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #e0f2fe, #eef2ff 45%, #f9fafb 100%);
      color: #111827;
    }

    .page-wrapper {
      max-width: 900px;
      margin: 40px auto;
      padding: 0 16px;
    }

    .story-card {
      background: rgba(255,255,255,0.96);
      border-radius: 20px;
      box-shadow:
        0 18px 40px rgba(15, 23, 42, 0.16),
        0 0 0 1px rgba(148, 163, 184, 0.18);
      padding: 24px 22px 20px;
      position: relative;
      overflow: hidden;
    }

    .story-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left,
        rgba(59,130,246,0.10),
        transparent 55%);
      pointer-events: none;
    }

    .story-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 12px;
      position: relative;
      z-index: 1;
    }

    .story-icon {
      width: 56px;
      height: 56px;
      border-radius: 18px;
      background: linear-gradient(135deg, #3b82f6, #6366f1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 28px;
      flex-shrink: 0;
      box-shadow: 0 10px 25px rgba(59,130,246,0.45);
    }

    h1 {
      font-size: 1.6rem;
      margin: 0 0 4px;
    }

    .story-subtitle {
      margin: 0;
      color: #6b7280;
      font-size: 0.95rem;
    }

    .story-body {
      margin-top: 10px;
      margin-bottom: 16px;
      font-size: 0.98rem;
      color: #374151;
      position: relative;
      z-index: 1;
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 4px;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .play-button {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #ecfdf5;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 24px rgba(22,163,74,0.45);
      transition: transform 0.08s, box-shadow 0.08s, filter 0.12s;
    }

    .play-button span.icon {
      font-size: 1.2rem;
    }

    .play-button:hover {
      filter: brightness(1.04);
    }

    .play-button:active {
      transform: translateY(1px);
      box-shadow: 0 6px 16px rgba(22,163,74,0.5);
    }

    .play-button:focus-visible {
      outline: 2px solid #2563eb;
      outline-offset: 3px;
    }

    .story-meta-pill {
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.18);
      color: #4b5563;
    }

    .timeline {
      margin-top: 10px;
      margin-bottom: 6px;
      position: relative;
      z-index: 1;
    }

    .timeline-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      position: relative;
    }

    .timeline-progress {
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, #3b82f6, #6366f1);
      transition: width 0.15s linear;
    }

    .timeline-time {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
      font-size: 0.8rem;
      color: #6b7280;
      font-variant-numeric: tabular-nums;
    }

    .hint-line {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #6b7280;
      position: relative;
      z-index: 1;
    }

    .status-text {
      margin-top: 6px;
      font-size: 0.85rem;
      color: #4b5563;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #9ca3af;
    }

    .status-dot.playing {
      background: #22c55e;
    }

    .status-dot.paused {
      background: #f97316;
    }

    .status-dot.idle {
      background: #9ca3af;
    }

    .status-dot.error {
      background: #ef4444;
    }

    .debug-mini {
      margin-top: 10px;
      font-size: 0.78rem;
      color: #9ca3af;
      font-family: "Consolas", monospace;
      max-height: 80px;
      overflow-y: auto;
      border-top: 1px dashed rgba(148,163,184,0.5);
      padding-top: 4px;
    }

    @media (max-width: 640px) {
      .story-card {
        border-radius: 16px;
        padding: 18px 16px;
      }
      .story-header {
        align-items: flex-start;
      }
      h1 {
        font-size: 1.4rem;
      }
      .story-icon {
        width: 48px;
        height: 48px;
        font-size: 24px;
      }
    }
  </style>
</head>

<body>
  <div class="page-wrapper">
    <div class="story-card" aria-live="polite">
      <div class="story-header">
        <div class="story-icon" aria-hidden="true">▶</div>
        <div>
          <h1 id="storyTitle">Luisterverhaal: bal</h1>
          <p id="storySubtitle" class="story-subtitle">
            Een kort luisterverhaal voor braille-leerlingen.
          </p>
        </div>
      </div>

      <div class="story-body" id="storyDescription">
        Het verhaal wordt geladen vanuit <code>stories.json</code> en daarna afgespeeld.
        Druk op de knop hieronder om te luisteren.
      </div>

      <div class="controls-row">
        <button id="playButton" class="play-button" type="button">
          <span class="icon" id="playIcon">▶</span>
          <span id="playLabel">Afspelen</span>
        </button>

        <span class="story-meta-pill" id="storyMeta">
          Verhaal “bal” · NL
        </span>
      </div>

      <div class="timeline" aria-hidden="false">
        <div class="timeline-bar">
          <div class="timeline-progress" id="timelineProgress"></div>
        </div>
        <div class="timeline-time">
          <span id="currentTime">00:00</span>
          <span id="totalTime">00:00</span>
        </div>
      </div>

      <p class="hint-line">
        Tip: gebruik de spatiebalk om te pauzeren / hervatten.
      </p>

      <div class="status-text">
        <span id="statusDot" class="status-dot idle"></span>
        <span id="statusText">Klaar om te starten…</span>
      </div>

      <div class="debug-mini" id="debugArea"></div>
    </div>
  </div>

  <script>
    const STORY_KEY = "bal";
    const STORIES_CONFIG_URL = "../config/stories.json";

    let player = null;
    let progressTimer = null;
    let storyLoaded = false;
    let audioUrl = null;

    const elTitle = document.getElementById("storyTitle");
    const elSubtitle = document.getElementById("storySubtitle");
    const elDescription = document.getElementById("storyDescription");
    const elMeta = document.getElementById("storyMeta");

    const btnPlay = document.getElementById("playButton");
    const elPlayIcon = document.getElementById("playIcon");
    const elPlayLabel = document.getElementById("playLabel");

    const elProgress = document.getElementById("timelineProgress");
    const elCurTime = document.getElementById("currentTime");
    const elTotalTime = document.getElementById("totalTime");

    const elStatusDot = document.getElementById("statusDot");
    const elStatusText = document.getElementById("statusText");
    const elDebug = document.getElementById("debugArea");

    function debug(msg) {
      const time = new Date().toLocaleTimeString();
      elDebug.textContent += `[${time}] ${msg}\n`;
      elDebug.scrollTop = elDebug.scrollHeight;
      console.log("[story-debug]", msg);
    }

    function setStatus(mode, text) {
      elStatusDot.className = "status-dot " + mode;
      elStatusText.textContent = text;
    }

    function formatTime(sec) {
      if (!isFinite(sec) || sec < 0) sec = 0;
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
    }

    function updatePlayButtonUI(isPlaying) {
      if (isPlaying) {
        elPlayIcon.textContent = "⏸";
        elPlayLabel.textContent = "Pauzeer";
      } else {
        elPlayIcon.textContent = "▶";
        elPlayLabel.textContent = "Afspelen";
      }
    }

    function startProgressTimer() {
      stopProgressTimer();
      progressTimer = setInterval(() => {
        if (!player) return;

        let pos = 0;
        try {
          pos = player.seek() || 0;
        } catch {
          pos = 0;
        }
        const dur = player.duration() || 0;

        elCurTime.textContent = formatTime(pos);
        elTotalTime.textContent = formatTime(dur);

        const pct = dur > 0 ? (pos / dur) * 100 : 0;
        elProgress.style.width = pct.toFixed(1) + "%";
      }, 200);
    }

    function stopProgressTimer() {
      if (progressTimer) {
        clearInterval(progressTimer);
        progressTimer = null;
      }
    }

    async function loadStoriesConfig() {
      debug("Laden van stories-config: " + STORIES_CONFIG_URL);

      const res = await fetch(STORIES_CONFIG_URL);
      if (!res.ok) {
        throw new Error(`Kan stories.json niet laden (${res.status} ${res.statusText})`);
      }

      const cfg = await res.json();
      const baseUrl = (cfg.baseUrl || "").replace(/\/+$/, "");
      const ext = cfg.defaultExtension || ".mp3";

      const story = cfg.stories && cfg.stories[STORY_KEY];
      if (!story) {
        throw new Error(`Verhaal-key '${STORY_KEY}' niet gevonden in stories.json`);
      }

      const title = story.title || `Luisterverhaal: ${STORY_KEY}`;
      const description = story.description || "Luisterverhaal uit stories.json.";
      const path = (story.path || "/sounds/nl/stories").replace(/\\/g, "/");
      const fileName = story.file || STORY_KEY;
      const lang = story.lang || "NL";

      audioUrl = `${baseUrl}${path.startsWith("/") ? "" : "/"}${path}/${fileName}${ext}`;

      elTitle.textContent = title;
      elDescription.textContent = description;
      elMeta.textContent = `Verhaal “${STORY_KEY}” · ${lang}`;
      elSubtitle.textContent = "Afspelen vanaf " + audioUrl;

      debug("Verhaal geladen: " + JSON.stringify({ title, path, fileName, audioUrl }, null, 2));

      return audioUrl;
    }

    function initPlayer(url) {
      if (player) {
        player.unload();
        player = null;
      }

      debug("Initialiseer Howler met URL: " + url);

      player = new Howl({
        src: [url],
        html5: true,
        preload: true,
        onload: () => {
          storyLoaded = true;
          const dur = player.duration() || 0;
          elTotalTime.textContent = formatTime(dur);
          debug("Audio geladen, duur = " + dur.toFixed(2) + "s");
          setStatus("idle", "Verhaal klaar om af te spelen.");
        },
        onplay: () => {
          updatePlayButtonUI(true);
          setStatus("playing", "Afspelen…");
          startProgressTimer();
          debug("Afspelen gestart.");
        },
        onpause: () => {
          updatePlayButtonUI(false);
          setStatus("paused", "Gepauzeerd.");
          debug("Afspelen gepauzeerd.");
        },
        onstop: () => {
          updatePlayButtonUI(false);
          setStatus("idle", "Gestopt.");
          debug("Afspelen gestopt.");
          stopProgressTimer();
        },
        onend: () => {
          updatePlayButtonUI(false);
          setStatus("idle", "Verhaal is afgelopen.");
          debug("Verhaal afgelopen.");
          stopProgressTimer();
          elProgress.style.width = "100%";
        },
        onloaderror: (id, err) => {
          setStatus("error", "Fout bij laden van audio.");
          debug("Load error: " + err);
        },
        onplayerror: (id, err) => {
          setStatus("error", "Fout bij afspelen (play error).");
          debug("Play error: " + err);
        }
      });
    }

    async function ensurePlayerReady() {
      if (player && storyLoaded) return;

      try {
        setStatus("idle", "Verhaal wordt geladen…");
        const url = audioUrl || await loadStoriesConfig();
        initPlayer(url);
      } catch (err) {
        setStatus("error", "Fout: " + err.message);
        debug("CONFIG ERROR: " + err.message);
      }
    }

    async function togglePlay() {
      await ensurePlayerReady();
      if (!player) return;

      try {
        if (player.playing()) {
          player.pause();
        } else {
          player.play();
        }
      } catch (err) {
        setStatus("error", "Kan niet afspelen.");
        debug("PLAY ERROR: " + err);
      }
    }

    btnPlay.addEventListener("click", togglePlay);

    window.addEventListener("keydown", ev => {
      if (ev.code === "Space") {
        ev.preventDefault();
        togglePlay();
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      setStatus("idle", "Verhaal wordt voorbereid…");
      // We beginnen alvast met het laden van stories.json op de achtergrond:
      loadStoriesConfig().then(url => {
        initPlayer(url);
      }).catch(err => {
        setStatus("error", "Fout bij laden stories.json");
        debug("INIT ERROR: " + err.message);
      });
    });
  </script>
</body>
</html>
