<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>BrailleUI Demo – BrailleServer</title>

  <!-- Shared styling from your repo -->
  <link rel="stylesheet" href="../css/style.css" />

  <!-- Optional: Howler, only if you want sounds here -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>

  <!-- Frameworks from BrailleServer -->
  <script src="../js/braillebridge.js"></script>
  <script src="../js/brailleui.js"></script>
  <script src="../js/sounds.js"></script>
</head>
<body>
  <main class="container">
    <h1>BrailleUI Demo</h1>

    <section class="card">
      <h2>Verbinding</h2>
      <p>Status: <span id="connectionStatus">disconnected</span></p>
    </section>

    <section class="card">
      <h2>Braille-monitor (1:1 met leesregel)</h2>
      <p id="brailleMonitor" class="mono-box">(leeg)</p>
    </section>

    <section class="card">
      <h2>Regel sturen</h2>
      <button id="btnHello">Stuur “Hallo braille!”</button><br /><br />

      <label for="customText">Eigen tekst:</label><br />
      <input id="customText" type="text"
             placeholder="Typ hier je tekst"
             style="width: 100%; max-width: 420px; margin-top: 4px;" /><br /><br />

      <button id="btnCustom">Stuur eigen tekst</button>
      <button id="btnRepeat">Herhaal huidige regel</button>
      <button id="btnClear">Maak leeg</button>
    </section>

    <section class="card">
      <h2>Laatste cursorinformatie</h2>
      <p id="lastCursor">Nog niets…</p>
    </section>

    <section class="card">
      <h2>Logging</h2>
      <pre id="logBox" class="log-box"></pre>
    </section>
  </main>

  <script>
    // ------------------------------------------------------------
    // Simpele logging helper
    // ------------------------------------------------------------
    function pageLog(msg) {
      const el = document.getElementById("logBox");
      if (!el) return;
      const time = new Date().toISOString().substring(11, 19);
      el.textContent += `[${time}] ${msg}\n`;
      el.scrollTop = el.scrollHeight;
      console.log(msg);
    }

    // Optioneel: globale logger-hub
    window.BrailleLog = {
      log(source, message) {
        pageLog(`[${source}] ${message}`);
      }
    };

    function setConnectionStatus(text, ok) {
      const el = document.getElementById("connectionStatus");
      if (!el) return;
      el.textContent = text;
      el.style.color = ok ? "green" : "red";
    }

    function setLastCursor(text) {
      const el = document.getElementById("lastCursor");
      if (el) el.textContent = text;
    }

    // ------------------------------------------------------------
    // INIT
    // ------------------------------------------------------------
    window.addEventListener("DOMContentLoaded", async () => {
      // 1. Sounds (optioneel)
      try {
        await Sounds.init("../config/sounds.json");
        pageLog("Sounds.init OK");
      } catch (e) {
        pageLog("Sounds.init fout: " + e);
      }

      // 2. BrailleBridge configureren
      BrailleBridge.setConfig({
        baseUrl: "http://localhost:5000",
        wsUrl: "ws://localhost:5000/ws",
        displayCells: 40,
        debug: true
      });

      // 3. BrailleUI configureren + monitor koppelen
      BrailleUI.setOptions({
        displayCells: 40,
        debug: true
      });
      BrailleUI.attachMonitor("brailleMonitor");

      // 4. Events van BrailleBridge
      BrailleBridge.on("connected", () => {
        setConnectionStatus("verbonden", true);
        pageLog("BrailleBridge connected.");
      });

      BrailleBridge.on("disconnected", info => {
        setConnectionStatus("verbinding verbroken", false);
        pageLog("BrailleBridge disconnected (" + (info.reason || "") + ")");
      });

      BrailleBridge.on("error", err => {
        pageLog("BrailleBridge error: " + JSON.stringify(err));
      });

      // Optional: ruwe cursorrouting loggen
      BrailleBridge.on("cursor", evt => {
        pageLog("[RAW cursor] " + JSON.stringify(evt));
      });

      // 5. Events van BrailleUI (letter + woord onder de cursor)

      // Letter onder de cursor: wordt altijd bijgewerkt
      BrailleUI.on("cursorChar", evt => {
        const letter = evt.char || "␣"; // spatie symbool
        const line   = evt.lineIndex;
        const col    = evt.column;

        setLastCursor(
          "Regel " + line +
          ", cel " + col +
          " → letter: \"" + letter + "\""
        );

        pageLog(
          "cursorChar line=" + line +
          " col=" + col +
          " letter=\"" + letter + "\""
        );
      });

      // Woord onder de cursor (als er een woord is)
      BrailleUI.on("cursorWord", evt => {
        const word   = evt.word || "(geen woord)";
        const line   = evt.lineIndex;
        const col    = evt.column;
        const letter = BrailleUI.getCharAt(col) || "␣";

        // Hier laten we zowel letter als woord zien
        setLastCursor(
          "Regel " + line +
          ", cel " + col +
          " → letter: \"" + letter + "\", woord: \"" + word + "\""
        );

        pageLog(
          "cursorWord line=" + line +
          " col=" + col +
          " letter=\"" + letter + "\" woord=\"" + word + "\""
        );

        // hier kun je eventueel geluid koppelen:
        // Sounds.playWord("nl", word);
      });

      // 6. Verbinden met BrailleBridge
      BrailleBridge.connect();

      // 7. Buttons aansluiten
      document.getElementById("btnHello").onclick = async () => {
        try {
          await BrailleUI.setText("Hallo braille!");
          pageLog("BrailleUI.setText('Hallo braille!') OK");
        } catch (e) {
          pageLog("setText fout: " + e);
        }
      };

      document.getElementById("btnCustom").onclick = async () => {
        const text = document.getElementById("customText").value || "(leeg)";
        try {
          await BrailleUI.setText(text);
          pageLog("BrailleUI.setText(custom) OK");
        } catch (e) {
          pageLog("setText(custom) fout: " + e);
        }
      };

      document.getElementById("btnRepeat").onclick = async () => {
        try {
          await BrailleUI.repeatLine();
          pageLog("BrailleUI.repeatLine OK");
        } catch (e) {
          pageLog("repeatLine fout: " + e);
        }
      };

      document.getElementById("btnClear").onclick = async () => {
        try {
          await BrailleUI.clear();
          pageLog("BrailleUI.clear OK");
        } catch (e) {
          pageLog("clear fout: " + e);
        }
      };
    });
  </script>
</body>
</html>
